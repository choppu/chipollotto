/*
 * Copyright (C) 2019, Ksenia Balistreri
 * All rights reserved.
 *
 * This software may be modified and distributed under the terms
 * of the BSD license.  See the LICENSE file for details.
 */

#include <string.h>
#include "vm.h"
#include "cpu.h"
#include "timer.h"
#include "display.h"
#include "audio.h"
#include "keypad.h"

#define FONT_ARR_LENGTH 80

const uint8_t c8_font[FONT_ARR_LENGTH] = {
		0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
		0x20, 0x60, 0x20, 0x20, 0x70, // 1
		0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
		0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
		0x90, 0x90, 0xF0, 0x10, 0x10, // 4
		0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
		0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
		0xF0, 0x10, 0x20, 0x40, 0x40, // 7
		0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
		0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
		0xF0, 0x90, 0xF0, 0x90, 0x90, // A
		0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
		0xF0, 0x80, 0x80, 0x80, 0xF0, // C
		0xE0, 0x90, 0x90, 0x90, 0xE0, // D
		0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
		0xF0, 0x80, 0xF0, 0x80, 0x80  // F
};


int c8_vm_run(c8_vm_t* vm) {
	memcpy(&vm->c8_memory[FONT_ADDR], c8_font, FONT_ARR_LENGTH);
	c8_timer_init();
	c8_display_init();
	c8_audio_init();

	vm->c8_run = 1;
	vm->c8_draw = 1;

	while (vm->c8_run) {
		c8_cpu_cycle(vm);
		c8_timer_update(vm);
		c8_keypad_scan(vm);
		c8_display_draw(vm);
		c8_audio_play(vm);
	}

	c8_display_destroy();
	c8_audio_destroy();

	return 0;
}
